# 창업진흥원 규정 질의응답 챗봇 프로젝트

## 프로젝트 개요
창업진흥원의 규정에 대한 질의응답을 처리하는 AI 챗봇 시스템입니다. 
키워드 매칭이 아닌 OpenAI API를 활용하여 정확하고 맥락적인 답변을 제공합니다.

## 시스템 아키텍처
1. **분류 에이전트**: 사용자 질문을 분석하여 가장 적합한 규정 선택 (15개 옵션: 14개 규정 + 규정없음)
2. **응답 생성 에이전트**: 선택된 규정 기반으로 답변 생성 또는 자연스러운 대화 처리
3. **스마트 폴백 시스템**: 규정과 무관한 질문 시 default.txt 기반 친근한 응답
4. **카카오톡 연동**: 5초 내 응답을 위한 최적화된 처리

## 에이전트 구현 방식
- **Upstage Solar-Pro2** 단독 사용 (안정성 최우선)
- 2단계 처리: 규정 분류 → 답변 생성
- 폴백 시스템 완전 제거로 단순화
- 62개 규정별 상세한 분류 정보 제공
- **카카오톡 콜백 시스템**: 5초 제한 완전 해결 (즉시 응답 + 백그라운드 처리)
- 실시간 성능 모니터링 (응답시간 측정)
- Google News RSS를 통한 실시간 뉴스 연동
- 대화 메모리 시스템으로 맥락적 대화 지원
- 마크다운 문법 금지로 순수 텍스트 출력
- AWS 환경 호환성 보장 (httpx 프록시 설정)

## 처리 가능한 규정 (62개 + 1개 폴백)
### 1. 중소기업창업 지원사업 운영요령
- 창업지원사업의 기본 운영체계와 절차를 규정
- 사업 신청자격, 선정기준, 협약체결 절차가 포함됨
- 창업기업 및 예비창업자의 지원 대상 기준 명시
- 사업 진행 과정에서의 관리감독 방법 규정
- 사업 완료 후 성과관리 및 사후관리 절차 포함
- **주요 키워드**: 신청, 자격, 절차, 협약, 관리

### 2. 창업사업화 지원사업 통합관리지침  
- 창업사업화 지원사업의 예산 집행과 회계처리 기준
- 각종 수당 및 인건비 지급 기준과 한도액 명시
- 평가위원, 멘토, 전문가에 대한 수당 지급 규정
- 사업비 사용 범위와 집행 절차 규정
- 정산 및 회계감사 관련 사항 포함
- **주요 키워드**: 수당, 비용, 지급, 예산, 회계

### 3. 전문계약직 운영지침
- 창업진흥원 전문계약직의 인사관리 규정
- 채용자격, 채용절차, 임기 및 신분에 관한 사항
- 급여체계, 연봉 책정기준, 성과급 규정
- 근무평정, 해임 사유, 퇴직금 등 처우 규정
- 등급별(가급~마급) 자격요건과 보수기준 명시
- **주요 키워드**: 전문계약직, 채용, 급여, 연봉, 등급

### 4-62. 기타 59개 규정
- 감사규정, 개인정보 보호지침, 계약사무처리규정, 공무직 운영지침
- 여비규정, 보수규정, 복무규정, 직위운용규칙, 직제규정  
- 채용 지침, 청년인턴 운영지침, 취업규칙, 퇴직금 지급 규정
- 위임전결규정, 인사규정, 임직원복지규정, 정관 등 59개 규정

### 63. Default 처리 (규정없음)
- 인사말, 자기소개, 감사 표현 등 일반 대화
- 창업 관련 일반 질문에 대한 자연스러운 안내
- 연락처 제공 없이 친근한 톤으로 규정 질문 유도

## 기술 스택
- **백엔드**: FastAPI
- **AI 모델**: Upstage Solar-Pro2 (안정성 + 속도 최적화)
- **언어**: Python 3.x
- **환경**: Windows
- **패키지**: openai, fastapi, pydantic, requests, xml
- **카카오톡 연동**: 카카오톡 챗봇 API

## 핵심 특징
- Upstage Solar-Pro2 모델로 100% 안정성 보장
- 규정 전체 내용을 활용한 맥락적 답변 (전체 파일 로드)
- 2단계 처리: 분류 → 응답 생성으로 정확성 향상
- 스마트 분류: 62개 규정 + 규정없음 옵션
- 자연스러운 대화 처리 (인사말, 일반 질문 등)
- **카카오톡 콜백 완전 지원**: 5초 제한 없이 정확한 답변 제공
- 친근한 답변 스타일 (줄바꿈 없는 연속 텍스트)
- 실시간 성능 모니터링 및 로깅 (영어 메시지)
- 오늘의 창업진흥원 뉴스 서비스 (Google News RSS 연동)
- 답변 품질 개선: 별표/참조 표현 금지, 구체적 수치 제시
- 대화 메모리 시스템: 사용자별 대화 이력 관리 및 맥락 유지
- 마크다운 문법 완전 금지: **, *, #, - 등 서식 문법 사용 안 함
- AWS 배포 최적화: httpx 프록시 호환성 및 환경변수 관리
- 뉴스 명령어 시 메모리 자동 초기화로 깔끔한 세션 관리

## API 엔드포인트
```
GET  /                         # 루트 - 시스템 정보
GET  /api/health              # 헬스체크
GET  /api/regulations         # 로드된 규정 목록 조회
POST /api/regulation-search   # 메인 - AI 기반 규정 질의응답
POST /api/test-classification # 개발용 - 분류 에이전트만 테스트
POST /api/kakao-chatbot       # 카카오톡 챗봇 메인 엔드포인트
GET  /docs                    # FastAPI 자동 문서화
```

## 코드 구조
```
backend/
├── main.py                   # FastAPI 애플리케이션 + 카카오톡 연동
├── memory.py                 # 대화 메모리 시스템 (ConversationMemory 클래스)
├── agents/
│   └── agent_system.py       # Upstage Solar-Pro2 기반 시스템 (분류+응답생성)
└── models/
    └── schemas.py           # 간소화된 Pydantic 스키마 (3개 필드)

data/  (63개 파일: 62개 규정 + 1개 default)
├── 감사규정.txt
├── 감사규정 시행규칙.txt
├── 개인정보 보호지침.txt
├── 계약사무처리규정.txt
├── 여비규정.txt
├── 보수규정.txt
├── 복무규정.txt
├── 전문계약직 운영지침.txt
├── 중소기업창업 지원사업 운영요령.txt
├── 창업사업화 지원사업 통합관리지침.txt
├── ... (기타 52개 규정 파일)
├── default.txt              # 일반 대화 및 자연스러운 응답용
└── conversation_memory.json # 사용자별 대화 이력 저장

requirements.txt             # 최신 패키지 버전 (고정 버전 제거)
.env                        # 환경변수 (UPSTAGE_API_KEY)
```

## 시스템 동작 과정

### 1. 웹 API 방식
1. **사용자 질문 입력** → `POST /api/regulation-search`
2. **분류 에이전트 실행** → 15개 옵션 중 최적 선택 (14개 규정 + 규정없음)
3. **응답 생성 에이전트 실행** → 선택에 따른 적절한 답변 생성
4. **간소화된 응답 반환** → 핵심 3개 필드만 포함

### 2. 카카오톡 챗봇 방식 (콜백 지원)
1. **카카오톡 질문 수신** → `POST /api/kakao-chatbot`
2. **즉시 콜백 응답** → `useCallback=true` 반환 (< 1초)
3. **백그라운드 AI 처리** → 분류 + 응답 생성 (시간 제약 없음)
4. **콜백 URL 전송** → 완료된 답변을 콜백으로 전송

### 3. 성능 모니터링 (영어 로깅)
```
Request started: '과장이 대전으로 출장가면...'
Classification agent started: 과장이 대전으로 출장가면...
Solar-Pro2 classification completed: 1.23s | Result: 여비규정
Response agent started: 여비규정.txt...
Solar-Pro2 response completed: 2.15s | Length: 98 chars
Request completed: 3.38s
==================================================
```

### 4. 오늘의 창업진흥원 뉴스
- **명령어**: "📮 오늘의 창업진흥원" 입력 시 실행
- **RSS 연동**: Google News에서 실시간 뉴스 수집
- **표시 형식**: 최대 10개 뉴스를 깔끔한 형태로 제공
- **포함 정보**: 뉴스 제목, 언론사, 발행시간, 링크
- **메모리 초기화**: 뉴스 조회 시 자동으로 대화 이력 초기화

## 응답 형식 예시

### 웹 API 응답 (간소화됨)
```json
{
  "query": "과장이 대전으로 2박 3일 출장가면 얼마 받을 수 있어",
  "answer": "과장(4급)이 대전으로 2박 3일 출장 시 일비 1일 30,000원, 숙박비 1박 70,000원으로 총 230,000원(일비 90,000원 + 숙박비 140,000원)을 받을 수 있어요.",
  "total_time": "3.38초"
}
```

### 일반 대화 응답 예시
```json
{
  "query": "안녕하세요",
  "answer": "안녕하세요! 창업진흥원 규정 질의응답 서비스입니다. 창업진흥원의 각종 규정에 대해 궁금한 점을 물어보세요.",
  "total_time": "2.15초"
}
```

### 카카오톡 챗봇 응답
```json
{
  "version": "2.0",
  "template": {
    "outputs": [
      {
        "simpleText": {
          "text": "과장(4급)이 대전으로 2박 3일 출장 시 일비 1일 30,000원, 숙박비 1박 70,000원으로 총 230,000원(일비 90,000원 + 숙박비 140,000원)을 받을 수 있어요."
        }
      }
    ]
  }
}
```

## 스마트 분류 시스템
### 분류 옵션 (63개)
1. **62개 규정**: 감사규정, 여비규정, 보수규정, 복무규정, 인사규정, 전문계약직지침, 위임전결규정, 창업사업화지침, 중소기업창업지원법, 공무직운영지침, 개인정보보호지침 등 62개 전체 규정
2. **규정없음**: 인사말, 일반 대화, 창업 관련 일반 질문

### 매핑 우선순위
1. **1순위**: "규정없음" → default.txt (자연스러운 대화)
2. **2순위**: 62개 규정 매핑 → 해당 규정 파일
3. **3순위**: 매핑 실패 → default.txt (안전 폴백)

## 환경 설정
- **Upstage API Key**: 환경변수로 설정 (.env 파일 참조)
- **OpenAI API Key**: 레거시 호환성 유지
- **개발 서버 실행**: `python -m uvicorn backend.main:app --reload --port 8000`
- **웹 테스트**: `http://localhost:8000/docs` (FastAPI 자동 문서화)
- **카카오톡 연동**: ngrok 등으로 외부 접근 가능한 URL 필요

## 카카오톡 챗봇 연동 설정
1. **웹훅 URL 설정**: `https://your-domain.com/api/kakao-chatbot`
2. **타임아웃 대응**: 3초 내 응답 보장 (Solar-Pro2로 최적화)
3. **외부 접근**: ngrok 등을 통한 로컬 개발 환경 노출 필요

## 최종 성능 최적화 결과
- **콜백 응답 속도**: < 1초 (즉시 응답), AI 처리: 시간 제약 없음
- **모델 안정성**: Upstage Solar-Pro2 단독 사용으로 100% 신뢰성
- **시스템 단순화**: 복잡한 폴백 제거, 깔끔한 아키텍처
- **비용 효율성**: Solar-Pro2 사용으로 API 비용 최적화
- **대화 품질**: 자연스러운 인사말 및 일반 대화 처리
- **뉴스 서비스**: 실시간 창업진흥원 뉴스 제공
- **답변 품질**: 별표 참조 금지, 구체적 수치 제시 강화

## 테스트 예시 질문

### 규정 관련 질문
- **수당 관련**: "선정평가 수당은 얼마인가요?", "평가수당 2시간하면 얼마야?"
- **출장비 관련**: "대리가 부산에 출장가면 숙박비 얼마받아?" → "대리 출장 숙박비는 부산(광역시) 기준 상한 8만원까지 실비로 지급됩니다"
- **절차 관련**: "창업기업 신청자격은?"  
- **전문계약직**: "전문계약직 가급 연봉은?", "전문계약직 채용 어떻게 해?"
- **휴가 관련**: "연차 며칠 줘?", "경조사 휴가는 며칠?"

### 일반 대화 질문
- **인사말**: "안녕하세요", "반갑습니다" → 서비스 소개
- **자기소개**: "너 누구야?", "뭐하는 곳이야?" → AI 어시스턴트 소개
- **감사 표현**: "고마워", "감사합니다" → 친근한 응답

### 뉴스 서비스 질문
- **뉴스 조회**: "📮 오늘의 창업진흥원" → 최신 10개 뉴스 제공 + 메모리 초기화

## 핵심 개선 사항
1. **AI 모델 업그레이드**: OpenAI GPT-4o-mini → Upstage Solar-Pro2로 전환
2. **규정 확대**: 14개 → 62개 규정으로 대폭 확장
3. **뉴스 서비스 추가**: Google News RSS 연동으로 실시간 창업진흥원 뉴스 제공
4. **답변 품질 개선**: 별표/참조 표현 금지, 구체적 수치 직접 제시
5. **환경변수 보안**: 하드코딩된 API 키를 .env 파일로 이동
6. **완전 단순화**: 폴백 시스템 제거로 예측 가능한 동작
7. **성능 모니터링**: 실시간 응답시간 측정 및 로깅 (영어 메시지)
8. **API 간소화**: 3개 핵심 필드만 반환하는 깔끔한 응답
9. **대화 메모리 시스템**: 사용자별 맥락 유지 및 연속 대화 지원
10. **마크다운 금지**: **, *, #, - 등 서식 제거로 순수 텍스트 출력
11. **AWS 배포 최적화**: httpx 프록시 호환성 및 환경 안정성 보장
12. **패키지 관리**: requirements.txt에서 버전 고정 제거, 최신 버전 자동 설치
13. **메모리 자동 관리**: 뉴스 조회 시 대화 이력 자동 초기화
14. **카카오톡 콜백 완전 구현**: 5초 제한 해결, 즉시 응답 + 백그라운드 처리