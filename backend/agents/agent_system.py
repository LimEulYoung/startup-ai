import os
import json
import time
from typing import Dict, List, Optional
from datetime import datetime
from openai import OpenAI
from backend.memory import ConversationMemory


class RegulationAgentSystem:
    def __init__(self):
        try:
            print("🔍 Step 1: Checking UPSTAGE_API_KEY...")
            upstage_api_key = os.getenv("UPSTAGE_API_KEY")
            if not upstage_api_key:
                raise ValueError("UPSTAGE_API_KEY environment variable is required")
            print("✓ UPSTAGE_API_KEY found")
            
            print("🔍 Step 2: Initializing OpenAI client...")
            self.client = OpenAI(
                api_key=upstage_api_key,
                base_url="https://api.upstage.ai/v1"
            )
            print("✓ OpenAI client created")
            
            print("🔍 Step 3: Loading regulation files...")
            self.regulations = self._load_regulations()
            print(f"✓ Loaded {len(self.regulations)} regulation files")
            
            print("🔍 Step 4: Initializing ConversationMemory...")
            self.memory = ConversationMemory()
            print("✓ ConversationMemory initialized")
            
            print("✅ RegulationAgentSystem initialization completed successfully")
            
        except Exception as e:
            print(f"❌ RegulationAgentSystem.__init__ failed: {e}")
            import traceback
            print("Full traceback:")
            traceback.print_exc()
            raise
    
    def _load_regulations(self) -> Dict[str, str]:
        """규정 파일들을 로드"""
        regs = {}
        data_dir = "data"
        if os.path.exists(data_dir):
            for filename in os.listdir(data_dir):
                if filename.endswith('.txt'):
                    with open(f"{data_dir}/{filename}", 'r', encoding='utf-8') as f:
                        regs[filename] = f.read()
        return regs
    
    def _classification_agent(self, user_query: str, user_id: Optional[str] = None) -> str:
        """규정 분류 에이전트"""
        start_time = time.time()
        print(f"분류 에이전트 시작: {user_query[:30]}...")
        
        # 대화 이력 컨텍스트 구성
        conversation_context = ""
        if user_id:
            conversation_context = self.memory.build_context_string(user_id)
            if conversation_context:
                conversation_context = f"\n최근 대화 이력:\n{conversation_context}\n"

        system_prompt = f"""당신은 창업진흥원 규정 분류 전문가입니다.
사용자 질문을 분석해서 가장 적합한 규정을 선택하세요.
{conversation_context}

🚨 **대화 맥락 우선 원칙** 🚨
- 대화 이력에 "[사용된 규정: XXX]"가 있다면, 현재 질문도 동일한 규정일 가능성이 **매우 높습니다**
- 이전에 사용한 규정을 **강력하게 우선** 고려하세요
- 질문이 불완전하거나 애매해도 이전 규정과 연관지어 해석하세요

분류 규칙:
1. **이전 규정 연속성 검사**: 대화 이력에서 마지막으로 사용된 규정을 확인하고, 현재 질문이 그 연장선상인지 우선 판단
2. **연속 질문 패턴**: "목록", "알려줘", "더", "그럼", "그것", "또", "어떤" 등은 99% 이전 주제의 연속
3. **맥락 우선**: 키워드가 없어도 맥락상 이전 규정의 연장이면 같은 규정 선택
4. **새로운 주제**: 명확히 다른 규정을 언급하거나 완전히 새로운 내용인 경우만 다른 규정 선택

다음 62개 규정 중에서 선택하세요:

1.  감사규정 시행규칙
- 이 규칙은 창업진흥원 감사업무의 체계적이고 투명한 운영을 위한 세부 지침을 마련합니다. 다양한 감사 종류의 실시 기준과 절차, 감사 결과에 따른 처분 요구 및 사후관리를 규정합니다. 특히 업무 최종 결재 전 검토하는 일상감사의 대상, 시기, 절차 등을 상세히 명시합니다.

2.  감사규정
- 이 규정은 창업진흥원의 자체 감사기구 운영과 감사 직무 수행을 위한 기준 및 절차를 명시합니다. 감사 종류와 방법, 감사인의 독립성 및 행동규범을 정의하고, 감사업무 절차와 보고체계를 상세히 규정합니다. 또한 임직원의 적극적인 업무 처리를 지원하기 위한 적극행정 면책 조항을 포함합니다.

3.  개인정보 보호지침
- 이 지침은 「개인정보 보호법」에 의거하여 창업진흥원의 개인정보보호 활동 운영 체계와 절차를 규정합니다. 개인정보의 수집, 이용, 제공, 파기 등 처리 과정 전반에 대한 원칙과 정보주체의 권리 보장 방안을 명시합니다. 조직체계, 민감정보 처리 기준, 기술적·관리적 보호조치, 유출 대응 및 영상정보처리기기 운영까지 포괄적으로 다룹니다.

4.  계약사무처리규정
- 이 규정은 창업진흥원의 계약 관련 업무 수행을 위한 기본 체계 및 절차를 규정합니다. 경쟁입찰 원칙과 수의계약 가능 사유를 명시하고, 입찰·낙찰 및 계약 체결·이행에 필요한 상세 절차를 제시합니다. 계약 과정의 투명성과 청렴성 확보를 위한 청렴 의무 및 일상감사 절차도 포함합니다.

5.  계약심의위원회 운영지침
- 이 지침은 창업진흥원 물품·일반용역 계약 업무의 투명성 제고 및 중요사항 심의를 위한 계약심의위원회 운영에 관한 사항을 규정합니다. 10억 원 이상 입찰공고, 긴급 입찰, 계약금액 30% 이상 변동 등 주요 계약 관련 사항을 심의·의결합니다. 위원회 구성, 운영 절차, 부정당업자 제재 결정 등 공정성 확보 방안을 포함합니다.

6.  공공데이터 제공과 관리에 관한 지침
- 이 지침은 공공데이터의 제공 및 관리에 대한 기본 원칙과 절차를 규정하여 국민의 이용권 보장 및 고품질 데이터 제공을 목적으로 합니다. 공공데이터 관리 및 제공을 위한 책임관의 역할과 데이터의 수집, 처리, 등록, 제공 및 품질관리에 필요한 기준과 방법을 제시합니다. 비공개 정보 처리 및 이용자의 제공 신청 절차를 포함하여 공공데이터 활성화를 도모합니다.

7.  공무직 운영지침
- 이 지침은 창업진흥원 공무직(무기계약직)의 채용, 승진, 승급, 보수 등 전반적인 인사 관리 체계 및 세부 절차를 규정합니다. 공무직의 정의와 직무, 정년 기준을 명확히 제시하며, 직위승진, 승급, 기본연봉 산정 기준을 상세히 규정합니다. 근무평정, 전보, 임금피크제 운영 등 인사 전반과 자격증 수당 등 보수 규정을 포함합니다.

8.  공용차량 관리지침
- 이 지침은 창업진흥원 공용차량의 효율적인 운영 및 관리를 위한 기본 체계와 절차를 규정합니다. 차량 배차 신청, 운행 기준, 운전자 의무 및 사고 발생 시 조치 방법을 명시합니다. 차량의 정비, 교체, 보험 가입 등 전반적인 관리 기준과 함께 사적 이용 방지 및 연간 운영 현황 공개 의무를 규정합니다.

9. 공직자의 이해충돌 방지제도 운영지침
- 이 지침은 창업진흥원 공직자의 이해충돌을 방지하고 공정한 직무수행을 보장하기 위한 제도 운영 기준을 마련합니다. 공직자의 사적이해관계 신고, 회피, 기피 신청 절차를 상세화하고, 특정 행위 제한 및 신고 의무를 규정합니다. 가족 채용 제한, 수의계약 체결 제한 등 직무 관련 행위 제한과 위반 시 조치 및 징계 기준을 포함합니다.

12. 근무평정 규칙
- 이 규칙은 창업진흥원 직원의 공정하고 객관적인 근무평정을 위한 기준과 절차를 명확히 규정합니다. 업적, 역량, 다면, 상향, 공통 및 가감평가를 포함한 종합적인 평가 방법을 제시하고, 성과 목표 설정 및 평가자별 비중을 상세히 규정합니다. 평가 결과는 4단계 등급으로 구분하여 인사관리 및 성과급 지급에 활용하며, 이의신청 절차를 통해 투명성을 보장합니다.

13. 기록물관리규정
- 이 규정은 창업진흥원의 투명하고 책임 있는 행정 구현을 위해 기록물의 생산부터 폐기까지 전 생애주기 관리 절차를 명시합니다. 기록관 설치 및 운영, 기록물 보존기간 및 공개 여부 기준을 제시하며, 기록물평가심의회를 통해 합리적인 관리를 보장합니다. 기록물의 전산화, 보안 관리 체계 구축 및 열람·대출 기준을 포함하여 안전한 보존과 효율적인 활용을 도모합니다.

14. 기부금 처리규칙
- 이 규칙은 창업진흥원에 접수되는 기부금의 접수, 사용, 관리 전반에 걸친 기준과 절차를 규정합니다. 기부금 접수 가능 및 불가 기준을 제시하여 투명성을 확보하고, 기부금 운영위원회의 심의와 이사회의 최종 승인 절차를 명시합니다. 사용 원칙, 결과 보고, 홈페이지 공개 의무 및 관련 세법 준수사항을 포함하여 공정하고 책임 있는 기부금 운용을 강조합니다.

15. 기업성장응답센터 운영지침
- 이 지침은 창업(중소)기업의 규제·애로를 발굴하고 해소하기 위한 기업성장응답센터의 운영 체계와 절차를 명시합니다. 센터를 총괄하는 주관부서와 민원 처리부서의 역할 및 책임을 규정하고, 규제혁신심의위원회를 통해 주요 사안을 심의합니다. 신고인으로부터 과제를 접수하여 검토, 처리결과 통보에 이르는 과정을 상세히 포함합니다.

16. 노사협의회 운영규정
- 이 규정은 노사협의회의 설치 및 운영에 관한 사항을 규정하여 근로자와 사용자 간 이해와 협력을 증진함을 목적으로 합니다. 협의회 위원의 구성, 선출 방법, 임기 및 회의 운영 방식과 안건 상정, 의결 절차를 명시합니다. 생산성 향상, 근로조건 개선 등 협의·의결·보고 대상 업무 범위와 고충처리위원회 및 중재 절차를 포함합니다.

17. 무기계약직 및 기간제근로자 인사규칙
- 이 규칙은 창업진흥원 무기계약직, 기간제 근로자 및 단시간 근로자의 채용, 근로조건, 근무평정 등 인사관리 전반에 대한 기준을 명시합니다. 근로자의 임용 원칙, 채용 절차, 근로계약 체결 및 해지 사유 등 고용 전반을 규정합니다. 급여, 복무, 평가, 교육훈련, 퇴직금 등 근로조건과 무기계약직 전환 자격 및 절차를 포함하여 효율적인 인력 운영 방안을 제시합니다.

18. 민간위탁관리위원회 운영규정
- 이 규정은 창업진흥원 민간위탁 사무의 공정하고 합리적인 운영 및 민간위탁 노동자의 근로조건 보호를 위해 민간위탁관리위원회의 구성과 운영 전반을 규정합니다. 관리위원회의 위원 구성, 위원장 선출, 회의 소집 절차 및 안건 제출 방식을 명시합니다. 민간위탁 계획 수립, 수탁기관 선정, 노동자 근로조건 보호 가이드라인 이행 등 주요 심의 사항을 정의합니다.

19. 민원사무처리규정
- 이 규정은 창업진흥원 민원 사무의 공정하고 적법한 처리 및 민원인 권익 보호를 위한 기본 운영 기준을 명시합니다. 민원의 유형, 접수, 이첩 절차 및 유형별 표준 처리 기간을 상세하게 안내합니다. 민원조정위원회를 설치하여 장기 미해결, 반복 민원 등에 대한 심의를 통해 공정성과 타당성을 확보하며, 민원 처리 결과 통지 의무 및 정보 보호 조치를 규정합니다.

20. 법무 및 소송사무 처리 규정
- 이 규정은 창업진흥원의 법무 및 소송사무 처리 전반에 대한 절차와 기준을 명확히 규정합니다. 소송, 행정심판, 법률자문 등 법무 업무 범위를 설정하고 법무총괄부서와 소관부서의 역할을 명시합니다. 소송 제기부터 판결 확정, 소송비용 처리까지의 상세 절차와 변호사 선임, 고문변호사 위촉 기준 등 윤리적 사항을 포함합니다.

21. 법인카드 관리지침
- 이 지침은 법인카드의 윤리적이고 투명한 사용을 위한 제반 사항을 규정합니다. 발급 기준, 사용 한도, 사적 사용 금지 및 클린카드 운영을 통한 제한 업종을 명시합니다. 업무추진비 집행 기준, 사용 내역 모니터링, 부적절 사용 시 조치 및 회계처리 절차를 포함하여 책임 있는 카드 관리를 강조합니다.

22. 보수규정
- 이 규정은 창업진흥원 임직원에 대한 보수 지급의 기본 원칙과 체계를 명확히 규정합니다. 임직원의 직무 능력과 성과에 대한 공정하고 합리적인 보상을 목표로 연봉제를 기본 보수 체계로 명시합니다. 보수를 기본연봉, 성과연봉, 부가급여로 구분하고 각 항목의 정의, 산정 및 지급 기준을 상세히 다룹니다.

23. 복무규정
- 이 규정은 창업진흥원 직원의 올바른 복무 자세 확립과 효율적인 조직 운영을 목표로 합니다. 직원의 준수사항, 직무상 의무, 윤리 및 품위 유지 의무를 명시하며, 표준 근무시간 및 유연근무 등 다양한 근무 형태를 규정합니다. 연차, 병가, 특별휴가 등 휴가의 종류와 사용 기준, 임산부 보호 조치 및 복무 위반행위에 대한 처분 기준을 포함합니다.

24. 부패행위 신고 접수처리 및 신고자 보호 등에 관한 운영지침
- 이 지침은 창업진흥원 임직원의 부패행위 및 행동강령 위반행위 신고 접수·처리 절차와 기준을 명시합니다. 신고자, 협조자에 대한 신분비밀 보장, 불이익조치 금지 및 신변보호 등 포괄적 보호 조치를 규정합니다. 부패행위 척결에 기여한 신고자에 대한 책임감면, 인사상 우대, 포상금 지급 추천 등 유인책을 마련하고, 원장 및 책임관의 역할과 외부 기관과의 협력 체계를 포함합니다.

25. 사무관리규정
- 이 규정은 창업진흥원 사무의 간소화, 표준화, 정보화를 통해 경영시스템의 효율적인 운영을 목적으로 합니다. 문서의 정의, 작성 원칙, 기안, 결재(위임전결 포함), 발송 및 접수 문서 처리 절차를 상세히 규정합니다. 또한 직인, 인감 등 인장의 종류, 용도, 날인 및 관리 절차를 포함하여 체계적인 사무 관리를 지원합니다.

26. 상품권 구매 및 관리지침
- 이 지침은 창업진흥원 내 상품권의 투명하고 합리적인 구매 및 사용에 대한 기준과 절차를 규정합니다. 구매 목적 명확화, 온누리상품권 우선 구매, 구매 신청 및 승인 절차 등 구매 세부사항을 명시합니다. 포상, 격려 등 사용 가능한 목적과 현금화 금지 등 부적절한 사용 제한 사항을 규정하고, 구매 및 배부 대장 관리, 사용 내역 공개 등 전반적인 관리 및 보고 체계를 확립합니다.

27. 성희롱·성폭력·직장 내 괴롭힘 예방지침
- 이 지침은 창업진흥원 내 성희롱, 성폭력, 직장 내 괴롭힘의 예방 및 근절을 위한 종합적인 운영 체계와 절차를 규정합니다. 피해자 고충 접수 및 조사, 피해자 보호 조치, 비밀 유지 의무 등을 통해 피해자 중심의 처리 절차를 마련합니다. 고충상담창구 운영, 예방 교육 의무 실시 및 행위자에 대한 징계 절차, 재발 방지 대책 수립을 포함하여 건전한 조직문화를 정착시킵니다.

28. 수당지급규칙
- 이 규칙은 창업진흥원의 각종 업무 수행에 필요한 외부 역무제공자에게 지급하는 수당의 종류와 그 지급 기준을 규정합니다. 회의 참석자, 심사·평가·감사 등 역무를 제공한 외부 전문가 및 창업진흥원이 위촉 또는 지정한 자를 지급 대상으로 명시합니다. 심사·평가수당, 강사수당 등 총 9가지 수당 종류별 시간당/건당 지급 기준 및 청탁금지법 적용 대상에 따른 지급 기준을 구체적으로 제시합니다.

29. 안전보건 관리규정
- 이 규정은 창업진흥원의 인명과 재산을 보호하고 직원의 건강 증진을 위해 사고·재해 방지 및 보건에 관한 사항을 종합적으로 규정합니다. 안전보건 조직체계와 각자의 역할을 명시하고, 안전경영책임계획 수립, 안전보건 교육, 위험성평가 시행 절차를 포함하여 선제적인 안전 관리를 강조합니다. 안전보건경영위원회 운영, 사업장 안전·보건 세부 지침 및 사고 발생 시 조치, 재해 보상과 포상 근거를 마련합니다.

30. 업무협약 관리규정
- 이 규정은 창업진흥원의 업무협약 체결 및 효율적인 관리를 위한 체계와 절차를 규정합니다. 업무협약의 목적, 정의, 기본 원칙 및 각 부서의 역할과 책임을 명확히 합니다. 협약 체결 전 타당성 검토, 사전 협의, 승인 절차를 규정하고, 협약 내용의 적정성 판단 기준을 제시합니다. 체결된 업무협약의 이력 관리, 변동사항 처리 절차 및 이행 현황 관리 방안을 포함합니다.

31. 여비규정
- 이 규정은 창업진흥원 임직원의 국내외 출장에 대한 여비 지급 기준 및 절차를 명확히 규정합니다. 국내여비, 국외여비, 기타여비(부임, 가족, 이전비)로 구분하고 운임, 체재비 등 여비의 종류를 상세히 정의합니다. 여비 계산, 지급 제한 기준, 직급별 지급 기준을 명시하며, 국외출장의 경우 마일리지 사적 사용 금지 등 관리 지침과 해외사무소 직원 및 사고 시 특별 기준을 마련합니다.

32. 연구용역 관리지침
- 이 지침은 창업진흥원 연구용역의 효율적인 관리체계와 절차를 규정합니다. 연구용역 계획 수립부터 연구자 선정, 계약 체결, 진행 상황 점검, 최종 결과 평가 및 활용에 이르는 전 과정을 다룹니다. 연구용역심의위원회 및 제안서평가위원회를 통해 투명성과 공정성을 확보하며, 부실 연구에 대한 경고 및 참여 제한 등 제재 방안을 명시하여 책임 있는 연구 수행을 유도합니다.

33. 연장근로수당지급 규칙
- 이 규칙은 임직원의 연장근로수당 지급에 관한 포괄적인 운영 기준을 제시합니다. 연장근로의 정의(시간외근무, 휴일근무)와 사전 승인 절차를 명확히 규정하고, 수당 계산을 위한 급여 항목 및 가산율(50%)을 상세히 명시합니다. 2급 이상 직원 등 지급 제외 대상을 설정하고, 월간 및 주간 연장근로 시간 상한을 규정하여 효율적인 근로 시간 관리를 도모합니다.

34. 위임전결규정
- 이 규정은 창업진흥원 내 업무처리의 합리성 및 신속성, 능률 향상을 위해 직위별(원장, 본부장/단장, 부서장, 파트장 등) 위임전결 사항을 규정합니다. 각 직위별 전결 권한 기준을 '위임전결권한 기준표'에 상세히 명시하며, 사업, 예산, 복무, 인사, 계약 등 주요 업무 분야별로 구체적인 전결 범위를 제시합니다. 전결권자의 권한과 책임, 타 부서와의 협의 절차 및 예외 사항을 포함합니다.

35. 이사회 운영규정
- 이 규정은 창업진흥원 이사회 운영에 필요한 제반 사항을 규정합니다. 이사회 구성, 소집 절차 및 의장, 간사 등 역할과 중요 안건 심의·의결 및 주요 규정 제·개정 절차를 명시합니다. 근로자 이사회 참관 제도를 통한 운영 투명성 확보 방안과 서면결의, 의사록 작성, 소위원회 운영 등 회의 진행 및 관리 기준을 제시합니다.

36. 인사규정
- 이 규정은 창업진흥원 직원의 인사, 근무평정, 상벌 등 전반적인 인사관리에 필요한 기준과 절차를 명확히 규정합니다. 직원의 채용, 승진, 전보, 휴직, 퇴직 등 생애주기 전반에 걸쳐 공정하고 효율적인 인사 운영을 목표로 합니다. 인사위원회를 통해 중요 사항을 심의하고, 공개 경쟁 채용, 직급 체계, 징계 기준 및 재심 절차 등을 상세히 포함하여 직원의 권리 보장과 성장을 지원합니다.

37. 인사위원회 운영규칙
- 이 규칙은 인사위원회의 구성, 기능, 의결 절차 등 운영 전반에 관한 기준을 제시합니다. 위원회의 구성, 위원장의 역할, 위원 및 간사의 자격과 임명 기준을 명시합니다. 안건 심의의 공정성, 기밀유지 의무, 의결 절차 및 제한 사항을 규정하고, 의사록 작성 및 결정 사항 통보 절차를 포함합니다. 관계인의 의견 청취 및 재심의 요청 절차를 마련하여 투명성을 보장합니다.

38. 임금피크제 운영규칙
- 이 규칙은 임금피크제 적용 대상 직원의 인사, 보수, 퇴직금 등에 관한 제반 사항을 규정합니다. 정규직, 무기계약직, 공무직 등 기간의 정함이 없는 근로계약을 체결한 직원을 대상으로 하며, 정년퇴직 2년 또는 3년 전부터 적용되는 유형별 운영 기준을 명시합니다. 임금피크제 대상자에 대한 직무 부여, 승진 제한 등 인사관리 방안과 전환 직전 급여 대비 연차별 지급률, 퇴직금 처리 규정을 구체화합니다.

39. 임원 복무 등에 관한 규정
- 이 규정은 창업진흥원 상임임원(원장)의 직무 수행과 관련된 복무 전반을 규정합니다. 성실, 청렴, 비밀엄수 등 임원의 기본 의무와 품위유지, 영리업무 금지 등의 행위기준을 명시합니다. 근무시간, 휴가, 외부강의 등 세부 복무사항과 임원의 책임 범위, 의원퇴직 및 직무정지 조건과 절차를 정합니다. 법령 및 규정 위반 시 문책의 종류와 이사회 심의 등 문책 절차를 규정합니다.

40. 임원 직무청렴계약 시행규정
- 이 규정은 창업진흥원 임원의 투명하고 청렴한 직무 수행을 위한 '직무청렴계약' 제도 운영 방안을 규정합니다. 임원의 직무청렴의무 내용을 명시하고, 직무 관련 부패행위 및 품위 손상 행위의 금지 사항과 벌칙 적용 시 공무원 의제 적용을 명시합니다. 직무청렴의무 위반 시 포상 취소, 성과급 지급 중지, 해임 건의 등의 제재 종류와 수준을 명시하며, 퇴직 후에도 위반 사항에 대한 제재를 적용합니다.

41. 임원추천위원회 운영규정
- 이 규정은 창업진흥원의 원장, 비상임감사, 비상임이사 등 임원 선임을 위한 임원추천위원회의 구성 및 운영에 관한 기본 체계와 절차를 규정합니다. 위원회 구성, 위원 자격, 임무 및 임원 후보자 모집 방법, 심사 원칙 및 절차를 상세화합니다. 특히 노동이사 후보자 선정을 위한 별도 절차를 포함하며, 심사의 공정성 확보를 위한 이해관계 참여 제한 조항을 명시합니다.

42. 임직원 직무관련 범죄고발 규칙
- 이 규칙은 창업진흥원 임직원의 직무 관련 범죄 행위에 대한 고발 대상과 절차를 명확히 규정하여 공직사회의 청렴성 및 투명성 확보를 목적으로 합니다. 임직원은 직무 수행 중 타 임직원의 범죄 혐의 발견 시 보고할 의무를 부여하며, 특히 금품수수, 공금횡령·유용 등 중대 비위에 대해서는 반드시 고발하도록 의무화합니다. 고발 대상 범위, 수사 협조 의무 및 보고·고발 미이행 시 징계 조치를 규정합니다.

43. 임직원복지규정
- 이 규정은 창업진흥원 임직원의 복리 증진, 건강 향상 및 생활 안정 도모를 목적으로 합니다. 임직원의 안전 및 보건 관리, 직장 체육 진흥, 다양한 수당 및 보조금 지급 기준을 상세히 규정하여 생활 안정과 교육을 지원합니다. 관사 지원, 피복 대여 등 주거 및 근무 환경 편의를 제공하고, 업무상 재해 보상 및 선택적 복지제도(복지카드 포인트)의 운영 방식을 포함합니다.

44. 전문계약직 운영지침
- 이 지침은 창업진흥원 내 전문계약직의 채용, 운영 및 처우에 관한 전반적인 사항을 규정합니다. 전문계약직의 자격 기준, 채용 절차 및 계약 기간을 명시하며, 담당 업무의 범위, 복무 및 의무 사항 등을 규정합니다. 급여체계(연봉제), 성과연봉 지급 기준, 퇴직금 등 보상 및 처우에 대한 세부 내용과 근무평정 및 해임 사유 등 인사 관리 기준을 제시합니다.

45. 전문위원제 운영지침
- 이 지침은 창업진흥원의 전문위원제 운영에 관한 세부사항을 규정합니다. 기관 운영 관련 중요사항 조사·연구·검토를 위한 전문위원 위촉 기준 및 범위를 명시하고, 전문위원의 자격 요건 및 등급별 보수 기준을 상세히 제시합니다. 전문위원의 임기 및 근무공간, 체재비 등 기타 지원 사항을 규정하여 전문적인 자문을 활용할 수 있도록 합니다.

46. 정관
- 이 정관은 창업진흥원의 설립 및 운영에 관한 근본적인 규칙과 체계를 규정하며, 기관의 존재 목적과 운영 전반에 대한 최고 지침을 제시합니다. 기관의 명칭, 목적, 주요 사업 범위, 임원 및 직원의 임면, 임기, 직무, 보수 등 인사 관리 전반을 규정합니다. 이사회 구성 및 운영, 재정 운영 체계, 책임 경영 구현 방안 및 정관 변경 절차를 포함하여 기관 운영의 근간을 확립합니다.

47. 정보공개지침
- 이 지침은 ‘공공기관의 정보공개에 관한 법률’에 의거하여 창업진흥원의 정보 공개 절차와 운영에 관한 전반적인 사항을 규정합니다. 사전 공표 대상 정보 및 청구에 의한 정보공개 등 공개 형태별 운영 기준과 방법을 명시합니다. 정보공개책임관의 역할, 정보공개심의회의 기능 및 비공개 대상 정보의 세부 기준을 포함하며, 정보공개 청구 처리 및 이의신청 등 불복 구제 절차를 규정합니다.

48. 정보화 업무규정
- 이 규정은 창업진흥원의 정보화 업무를 효율적으로 추진하기 위한 전반적인 체계와 절차를 규정합니다. 정보화 계획 수립부터 정보화사업 추진, 정보시스템 구축 및 운영에 이르는 전 과정을 명시합니다. 정보화 총괄책임자 등 명확한 역할 분담과 정보화협의체 운영을 통한 심의·조정 체계를 구축하고, 하드웨어 및 소프트웨어 등 정보자원의 관리 기준 및 성과관리 절차를 포함합니다.

49. 제규정관리규정
- 이 규정은 창업진흥원 내 모든 규정의 제정, 개정, 폐지 및 전반적인 관리 업무를 위한 절차와 기준을 명확히 제시합니다. 규정의 입안, 심사, 확정, 등록, 시행 등 제규정의 전체적인 운영 과정을 체계화합니다. 규정의 위계, 효력, 해석 기준을 설정하고 감사부서의 일상감사 및 부패영향평가 실시 의무를 포함하여 투명하고 효율적인 규정 관리 체계를 구축합니다.

50. 중소기업창업 지원법 시행령 (약칭: 중소기업창업법 시행령)
- 이 시행령은 「중소기업창업 지원법」에서 위임된 사항과 그 시행에 필요한 세부 기준 및 절차를 규정합니다. 창업 및 창업기업의 범위, 국외 창업 등 지원 대상에 대한 명확한 정의 및 제외 업종을 명시합니다. 창업 활성화 및 재창업 지원사업 운영 절차, 창업기업의 부담금 면제, 공공기관 우선구매, 공장 설립 절차 특례 등 성장을 위한 지원책을 상세화합니다.

51. 중소기업창업 지원법
- 이 법은 국민의 창의적인 창업 도전과 글로벌 성장을 위한 창업생태계 조성을 목적으로 하며, 국가 경제의 성장동력과 일자리 창출을 목표로 합니다. 창업, 창업기업 등 관련 용어 정의 및 정부와 기업의 책무를 명시하고, 체계적인 창업지원 정책 수립 및 활성화 지원사업 추진 근거를 마련합니다. 창업 저변 확대, 규제 완화, 신산업·기술 창업 육성, 금융지원 및 재창업 기회 확대를 위한 다양한 시책을 포함하며, 공장 설립 절차 특례 및 전문 지원기관 설립·운영 사항을 규정합니다.

52. 중소기업창업 지원사업 운영요령
- 이 요령은 중소기업창업 지원법에 근거하여 창업지원사업의 체계적인 운영을 위한 전반적인 절차와 기준을 제시합니다. 사업의 기획, 공고, 신청, 선정, 협약, 사업비 지원 및 관리, 성과 보고 및 평가, 사후관리 및 제재에 이르는 전 과정을 아우릅니다. 중소벤처기업부 등 사업 참여 주체별 역할과 의무를 명확히 규정하며, 공정하고 투명한 사업 추진을 위해 평가위원회 운영 및 이의신청 절차를 명시합니다.

53. 직위운용규칙
- 이 규칙은 창업진흥원 내 직원의 직위 운영 및 호칭 부여에 관한 사항을 규정합니다. 선임부장부터 사원까지 직위의 세부 분류 체계를 명시하고, 임용 시 직위 부여 원칙 및 겸직 직책 운영 방법을 포함합니다. 업무 특성에 따른 직급, 직위, 직책별 호칭 기준을 상세히 제시하여 조직 내 명확한 직위 체계와 호칭 사용을 통한 효율적인 인사관리를 지원합니다.

54. 직제규정
- 이 규정은 창업진흥원의 효율적인 운영을 위해 직제, 조직 구조, 각 부서의 업무분장, 그리고 직원의 정원에 관한 세부 사항을 명확히 규정합니다. 원장 등 임직원의 직위 및 직책과 직원 직급 체계를 명시하고, 창진원의 기구 구성 및 하부조직 편제를 상세화합니다. 각 팀의 세부적인 업무분장, 직종별·직급별 정원, 직무대행, 권한 위임 및 겸직에 대한 기준을 제시하여 조직 운영의 근간을 이룹니다.

55. 창업사업화 지원사업 통합관리지침
- 이 지침은 창업 사업화 지원사업의 전반적인 운영 및 관리에 필요한 구체적인 기준과 절차를 명시합니다. 중소벤처기업부, 창업진흥원, 주관기관 등 지원사업 참여 기관별 역할과 책임을 정의하고, 예비창업자 및 창업기업의 사업 신청, 선정, 협약 체결 및 변경, 해지 절차를 규정합니다. 정부지원사업비의 구성, 비목별 집행 기준, 정산 절차, 성공환원금 회수 및 사업 위반 시 제재와 환수 기준을 포함합니다.

56. 채용 지침
- 이 지침은 창업진흥원 직원의 신규 채용에 필요한 세부 절차와 기준을 명확히 정립하여 공정하고 투명한 채용 과정을 운영하는 것을 목적으로 합니다. 채용 계획 수립부터 서류, 필기, 면접 등 각 전형 단계에서의 평가 기준 및 합격자 결정 방법을 포괄적으로 규정합니다. 채용 과정의 공정성과 투명성을 최우선으로 확보하기 위한 감사부서 참여, 외부위원이 참여하는 검증위원회 운영, 부정행위자 제재 및 친인척 채용 현황 공개 등 다양한 제도적 장치를 명시합니다.

57. 청년인턴 채용 및 운영 지침
- 이 지침은 창업진흥원 청년인턴의 채용부터 운영 전반에 걸친 사항을 규정합니다. 청년인턴의 정의, 운용 방향, 관리 부서의 역할 등 기본 체계를 명시하고, 채용 방식(공개경쟁 원칙), 자격 요건 및 결격 사유에 대한 기준을 제시합니다. 근로계약 체결, 보수 체계, 휴가 부여 등 근로 조건과 인턴의 근무 태도 및 실적 평가 기준, 우수 인턴 지원 방안을 포함합니다.

58. 취업규칙
- 이 규칙은 창업진흥원 근로자의 채용, 복무, 근로조건 및 퇴직 등 근로관계 전반에 대한 기본 원칙과 절차를 규정합니다. 채용 전형, 시용 기간, 근로계약 체결 등 채용 관련 사항을 포함하며, 복무 의무, 근로시간, 각종 휴가, 출장 등 근로자의 근무 관리를 규정합니다. 임금 계산 및 지급, 승급, 상여금, 퇴직금 지급 기준과 퇴직 사유, 해고 제한 등 근로관계 종료에 관한 절차를 명시합니다.

59. 퇴직금 지급 규정
- 이 규정은 창업진흥원 임원 및 직원의 퇴직급여 지급에 관한 기본 운영 사항을 규정합니다. 퇴직급여 지급 대상자의 자격 요건(계속근로기간 1년 이상 등)을 명시하고, 퇴직금, 확정급여형 퇴직연금(DB), 확정기여형 퇴직연금(DC) 등 퇴직급여 종류별 지급기준 및 산정 방법을 상세히 규정합니다. 임원 퇴직금의 감액 지급 사유, 명예퇴직수당 지급 기준, 계속근로기간 계산 방법 및 퇴직급여 수령 권리의 소멸시효를 포함합니다.

60. 협상에 의한 계약 제안서평가 지침
- 이 지침은 창업진흥원이 협상에 의한 계약 방식으로 체결하는 물품·일반용역 계약의 제안서 평가 집행에 필요한 세부 절차와 기준을 명시합니다. 평가위원회 구성 및 운영을 통해 평가의 전문성과 신뢰성을 확보하며, 제안서 평가 절차 및 방법(기술능력, 입찰가격)과 특정 사업 유형에 대한 세부 평가 항목을 포함합니다. 평가위원 사전 접촉 금지 등 공정성 확보 및 관리 방안을 강화하고, 협상 및 결과 통보 절차를 규정합니다.

61. 회계감사인선임위원회 운영규정
- 이 규정은 창업진흥원의 회계감사를 수행할 감사인 선정에 필요한 회계감사인 선임위원회의 구성 및 운영 전반을 규정합니다. 비상임감사 및 비상임이사로 구성된 위원회의 구성과 기능, 위원장 선임 방식 등을 명시합니다. 위원회의 소집, 개의, 의결 등 회의 운영 절차를 상세화하고, 감사인의 자격, 선정 시기, 선정 및 변경 절차, 그리고 계약 체결 및 관리 방안을 포함합니다.

62. 회계규정
- 이 규정은 창업진흥원의 회계, 예산, 결산에 관한 기준과 주요 절차를 규정하여 운영의 합리화 및 효율화를 도모합니다. 발생주의 및 복식부기 회계원칙을 기반으로 자체수입회계와 위탁사업회계를 구분하고, 회계 책임자 및 담당자의 역할을 정의합니다. 예산의 편성, 관리, 통제, 집행 절차와 금전 수입 및 지출, 전도금의 신청·관리·정산 절차, 유형자산 관리 및 연말 결산, 재무제표 작성 절차를 포함하여 투명한 재정 운영을 강조합니다.

사용자 질문의 핵심 의도를 파악해서 다음 중 **정확히 하나의 규정 이름만** 답변하세요.

⚠️ **답변 형식**: 설명 없이 규정 이름만 "-규정이름" 형태로 답변
예시: "-aa규정", "-bb규정"

선택할 수 있는 규정:
-감사규정 시행규칙
-감사규정
-개인정보 보호지침
-계약사무처리규정
-계약심의위원회 운영지침
-공공데이터 제공과 관리에 관한 지침
-공무직 운영지침
-공용차량 관리지침
-공직자의 이해충돌 방지제도 운영지침
-근무평정 규칙
-기록물관리규정
-기부금 처리규칙
-기업성장응답센터 운영지침
-노사협의회 운영규정
-무기계약직 및 기간제근로자 인사규칙
-민간위탁관리위원회 운영규정
-민원사무처리규정
-법무 및 소송사무 처리규정
-법인카드 관리지침
-보수규정
-복무규정
-부패행위 신고 접수처리 및 신고자 보호 등에 관한 운영지침
-사무관리규정
-상품권 구매 및 관리지침
-성희롱, 성폭력, 직장 내 괴롭힘 예방지침
-수당지급규칙
-안전보건 관리규정
-업무협약 관리규정
-여비규정
-연구용역 관리지침
-연장근로수당지급 규칙
-위임전결규정
-이사회 운영규정
-인사규정
-인사위원회 운영규칙
-임금피크제 운영규칙
-임원 복무 등에 관한 규정
-임원 직무청렴계약 시행규정
-임원추천위원회 운영규정
-임직원 직무관련 범죄고발 규칙
-임직원복지규정
-전문계약직 운영지침
-전문위원제 운영지침
-정관
-정보공개지침
-정보화 업무규정
-제규정관리규정
-중소기업창업 지원법 시행령
-중소기업창업 지원법
-중소기업창업 지원사업 운영요령
-직위운용규칙
-직제규정
-창업사업화 지원사업 통합관리지침
-채용 지침
-청년인턴 운영지침
-취업규칙
-퇴직금 지급 규정
-협상에 의한 계약 제안서평가 지침
-회계감사인선임위원회 운영규정
-회계규정
-규정없음 (위의 62개 규정과 관련이 없는 질문인 경우)"""

        response = self.client.chat.completions.create(
            model="solar-pro2",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": f"사용자 질문: {user_query}"}
            ],
            temperature=0.1,
            max_tokens=30,
            reasoning_effort="low"
        )
        
        result = response.choices[0].message.content.strip()
        elapsed = time.time() - start_time
        print(f"solar-pro2 분류 완료: {elapsed:.2f}초 | 결과: {result}")
        
        # 규정없음인지 먼저 확인
        if "규정없음" in result:
            return "default.txt"
            
        # 파일명 매핑 (62개 규정 전체)
        regulation_mapping = {
            "감사규정시행규칙": "감사규정 시행규칙.txt",
            "감사규정 시행규칙": "감사규정 시행규칙.txt",
            "감사규정": "감사규정.txt",
            "개인정보보호지침": "개인정보 보호지침.txt",
            "개인정보 보호지침": "개인정보 보호지침.txt",
            "계약사무처리규정": "계약사무처리규정.txt",
            "계약심의위원회운영지침": "계약심의위원회 운영지침.txt",
            "계약심의위원회 운영지침": "계약심의위원회 운영지침.txt",
            "고객만족경영시스템운영지침": "고객만족경영시스템 운영지침.txt",
            "고객만족경영시스템 운영지침": "고객만족경영시스템 운영지침.txt",
            "공공데이터제공관리지침": "공공데이터 제공과 관리에 관한 지침.txt",
            "공공데이터 제공과 관리에 관한 지침": "공공데이터 제공과 관리에 관한 지침.txt",
            "공무직운영지침": "공무직 운영지침.txt",
            "공무직 운영지침": "공무직 운영지침.txt",
            "공용차량관리지침": "공용차량 관리지침.txt",
            "공용차량 관리지침": "공용차량 관리지침.txt",
            "공직자이해충돌방지제도운영지침": "공직자의 이해충돌 방지제도 운영지침.txt",
            "공직자의 이해충돌 방지제도 운영지침": "공직자의 이해충돌 방지제도 운영지침.txt",
            "규범준수윤리경영시스템운영지침": "규범준수윤리경영시스템 운영지침.txt",
            "규범준수윤리경영시스템 운영지침": "규범준수윤리경영시스템 운영지침.txt",
            "근무평정규칙": "근무평정 규칙.txt",
            "근무평정 규칙": "근무평정 규칙.txt",
            "기록물관리규정": "기록물관리규정.txt",
            "기부금처리규칙": "기부금 처리규칙.txt",
            "기부금 처리규칙": "기부금 처리규칙.txt",
            "기업민원보호서비스헌장운영규정": "기업민원 보호·서비스헌장 운영규정.txt",
            "기업민원 보호·서비스헌장 운영규정": "기업민원 보호·서비스헌장 운영규정.txt",
            "기업성장응답센터운영지침": "기업성장응답센터 운영지침.txt",
            "기업성장응답센터 운영지침": "기업성장응답센터 운영지침.txt",
            "노사협의회운영규정": "노사협의회 운영규정.txt",
            "노사협의회 운영규정": "노사협의회 운영규정.txt",
            "무기계약직기간제근로자인사규칙": "무기계약직 및 기간제근로자 인사규칙.txt",
            "무기계약직 및 기간제근로자 인사규칙": "무기계약직 및 기간제근로자 인사규칙.txt",
            "민간위탁관리위원회운영규정": "민간위탁관리위원회 운영규정.txt",
            "민간위탁관리위원회 운영규정": "민간위탁관리위원회 운영규정.txt",
            "민원사무처리규정": "민원사무처리규정.txt",
            "법무소송사무처리규정": "법무 및 소송사무 처리규정.txt",
            "법무 및 소송사무 처리규정": "법무 및 소송사무 처리규정.txt",
            "법무및소송사무처리규정": "법무 및 소송사무 처리규정.txt",
            "법인카드관리지침": "법인카드 관리지침.txt",
            "법인카드 관리지침": "법인카드 관리지침.txt",
            "부패영향평가업무처리지침": "부패영향평가 업무처리 지침.txt",
            "부패영향평가 업무처리 지침": "부패영향평가 업무처리 지침.txt",
            "보수규정": "보수규정.txt",
            "복무규정": "복무규정.txt",
            "부패행위신고처리신고자보호운영지침": "부패행위 신고 접수처리 및 신고자 보호 등에 관한 운영지침.txt",
            "부패행위 신고 접수처리 및 신고자 보호 등에 관한 운영지침": "부패행위 신고 접수처리 및 신고자 보호 등에 관한 운영지침.txt",
            "사무관리규정": "사무관리규정.txt",
            "상품권구매관리지침": "상품권 구매 및 관리지침.txt",
            "상품권 구매 및 관리지침": "상품권 구매 및 관리지침.txt",
            "성희롱성폭력직장괴롭힘예방지침": "성희롱, 성폭력, 직장 내 괴롭힘 예방지침.txt",
            "성희롱, 성폭력, 직장 내 괴롭힘 예방지침": "성희롱, 성폭력, 직장 내 괴롭힘 예방지침.txt",
            "수당지급규칙": "수당지급규칙.txt",
            "안전보건관리규정": "안전보건 관리규정.txt",
            "안전보건 관리규정": "안전보건 관리규정.txt",
            "안전사고임원문책규정": "안전사고에 관한 임원 문책규정.txt",
            "안전사고에 관한 임원 문책규정": "안전사고에 관한 임원 문책규정.txt",
            "업무협약관리규정": "업무협약 관리규정.txt",
            "업무협약 관리규정": "업무협약 관리규정.txt",
            "연구용역관리지침": "연구용역 관리지침.txt",
            "연구용역 관리지침": "연구용역 관리지침.txt",
            "연장근로수당지급규칙": "연장근로수당지급 규칙.txt",
            "연장근로수당지급 규칙": "연장근로수당지급 규칙.txt",
            "여비규정": "여비규정.txt",
            "윤리강령": "윤리강령.txt",
            "위임전결규정": "위임전결규정.txt",
            "이사회운영규정": "이사회 운영규정.txt",
            "이사회 운영규정": "이사회 운영규정.txt",
            "인권경영지침": "인권경영 지침.txt",
            "인권경영 지침": "인권경영 지침.txt",
            "인사규정": "인사규정.txt",
            "인사위원회운영규칙": "인사위원회 운영규칙.txt",
            "인사위원회 운영규칙": "인사위원회 운영규칙.txt",
            "임금피크제운영규칙": "임금피크제 운영규칙.txt",
            "임금피크제 운영규칙": "임금피크제 운영규칙.txt",
            "임원복무규정": "임원 복무 등에 관한 규정.txt",
            "임원 복무 등에 관한 규정": "임원 복무 등에 관한 규정.txt",
            "임원직무청렴계약시행규정": "임원 직무청렴계약 시행규정.txt",
            "임원 직무청렴계약 시행규정": "임원 직무청렴계약 시행규정.txt",
            "임원추천위원회운영규정": "임원추천위원회 운영규정.txt",
            "임원추천위원회 운영규정": "임원추천위원회 운영규정.txt",
            "임직원직무관련범죄고발규칙": "임직원 직무관련 범죄고발 규칙.txt",
            "임직원 직무관련 범죄고발 규칙": "임직원 직무관련 범죄고발 규칙.txt",
            "임직원행동강령": "임직원 행동강령.txt",
            "임직원 행동강령": "임직원 행동강령.txt",
            "임직원복지규정": "임직원복지규정.txt",
            "적극행정면책제도운영지침": "적극행정 면책제도 운영지침.txt",
            "적극행정 면책제도 운영지침": "적극행정 면책제도 운영지침.txt",
            "전문계약직운영지침": "전문계약직 운영지침.txt",
            "전문계약직 운영지침": "전문계약직 운영지침.txt",
            "전문위원제운영지침": "전문위원제 운영지침.txt",
            "전문위원제 운영지침": "전문위원제 운영지침.txt",
            "정관": "정관.txt",
            "정보공개지침": "정보공개지침.txt",
            "정보화업무규정": "정보화 업무규정.txt",
            "정보화 업무규정": "정보화 업무규정.txt",
            "제규정관리규정": "제규정관리규정.txt",
            "중소기업창업지원법시행령": "중소기업창업 지원법 시행령.txt",
            "중소기업창업 지원법 시행령": "중소기업창업 지원법 시행령.txt",
            "중소기업창업지원법": "중소기업창업 지원법.txt",
            "중소기업창업 지원법": "중소기업창업 지원법.txt",
            "중소기업창업지원사업운영요령": "중소기업창업 지원사업 운영요령.txt",
            "중소기업창업 지원사업 운영요령": "중소기업창업 지원사업 운영요령.txt",
            "직위운용규칙": "직위운용규칙.txt",
            "직제규정": "직제규정.txt",
            "창업사업화지원사업통합관리지침": "창업사업화 지원사업 통합관리지침.txt",
            "창업사업화 지원사업 통합관리지침": "창업사업화 지원사업 통합관리지침.txt",
            "채용지침": "채용 지침.txt",
            "채용 지침": "채용 지침.txt",
            "청렴시민감사관설치운영지침": "청렴시민감사관 설치 및 운영에 관한 지침.txt",
            "청렴시민감사관 설치 및 운영에 관한 지침": "청렴시민감사관 설치 및 운영에 관한 지침.txt",
            "청년인턴운영지침": "청년인턴 운영지침.txt",
            "청년인턴 운영지침": "청년인턴 운영지침.txt",
            "청원심의회운영규정": "청원심의회 운영규정.txt",
            "청원심의회 운영규정": "청원심의회 운영규정.txt",
            "취업규칙": "취업규칙.txt",
            "퇴직금지급규정": "퇴직금 지급 규정.txt",
            "퇴직금 지급 규정": "퇴직금 지급 규정.txt",
            "협상계약제안서평가지침": "협상에 의한 계약 제안서평가 지침.txt",
            "협상에 의한 계약 제안서평가 지침": "협상에 의한 계약 제안서평가 지침.txt",
            "회계감사인선임위원회운영규정": "회계감사인선임위원회 운영규정.txt",
            "회계감사인선임위원회 운영규정": "회계감사인선임위원회 운영규정.txt",
            "회계규정": "회계규정.txt"
        }
        
        # 매핑에서 찾기
        for key, filename in regulation_mapping.items():
            if key in result:
                if filename in self.regulations:
                    return filename
        
        # 매핑에서 찾지 못한 경우 기본값
        return "default.txt"
    
    def _response_agent(self, user_query: str, regulation_file: str, user_id: Optional[str] = None) -> str:
        """답변 생성 에이전트"""
        start_time = time.time()
        print(f"응답 생성 시작: {regulation_file[:30]}...")
        
        regulation_content = self.regulations[regulation_file]
        
        # 직급 정보 추가
        job_grade_info = """
직급 정보:
- 3급: 차장
- 4급: 과장  
- 5급: 주임 또는 대리
- 6급: 사원
- 팀장: 1(나)급, 1(가)급, 또는 2급 직원 중 하나
"""
        
        # 대화 이력 컨텍스트 구성
        conversation_context = ""
        if user_id:
            conversation_context = self.memory.build_context_string(user_id)
            if conversation_context:
                conversation_context = f"\n최근 대화 이력:\n{conversation_context}\n"

        # default.txt 파일인지 확인하여 시스템 프롬프트 변경
        if regulation_file == "default.txt":
            system_prompt = f"""당신은 창업진흥원의 친근한 AI 어시스턴트입니다.
{conversation_context}
답변 규칙:
1. 반드시 한 줄로 연속된 텍스트로만 답변 (줄바꿈, 리스트, 구분자 금지)
2. 카카오톡 메신저에서 사용할 것이므로 줄바꿈 없는 일반 텍스트만 사용
3. 친근하고 자연스럽게 대화
4. 최근 대화 이력이 있다면 맥락을 고려해서 답변

상황별 답변 방식:
- 인사말 (안녕, 안녕하세요, 반갑습니다 등): "안녕하세요! 창업진흥원 규정 질의응답 서비스입니다. 창업진흥원의 각종 규정에 대해 궁금한 점을 물어보세요."
- 자기소개 질문 (너누구야, 뭐하는곳이야 등): "저는 창업진흥원 규정에 대한 질문에 답변해드리는 AI 어시스턴트예요. 여비규정, 보수규정, 복무규정 등 다양한 규정 관련 질문을 도와드릴 수 있어요."  
- 감사 표현 (고마워, 감사합니다 등): "도움이 되셨다니 기쁘네요! 또 궁금한 것이 있으시면 언제든지 물어보세요."
- 기타 일반적인 대화: 자연스럽게 창업진흥원 규정 질문으로 유도"""
        else:
            system_prompt = f"""당신은 창업진흥원 규정 질의응답 전문가입니다.
주어진 규정을 바탕으로 사용자 질문에 정확하고 간결한 답변을 제공하세요.
{conversation_context}
답변 규칙:
1. 카카오톡 메신저에서 사용할 것이므로 줄바꿈 없는 일반 텍스트만 사용
2. 질문에 정확히 대응하는 내용만 답변
3. 수당/금액 질문이면 구체적 수치와 간단한 설명을 한 문장으로
4. 카카오톡 대화하듯 친근하고 자연스럽게(존댓말 사용)
5. 최근 대화 이력이 있다면 맥락을 고려해서 답변
6. 절대 금지 표현: "별표", "별표1", "[별표 1]", "부록", "부표", "참조", "~에 따라", "~기준", "표 참조" 등
7. 규정 문서나 표를 언급하지 말고 답변 자체에 필요한 정보를 모두 포함하세요

{job_grade_info}"""

        user_message = f"""사용자 질문: {user_query}

관련 규정:
{regulation_content}

위 규정을 참고해서 질문에 답변해주세요."""

        response = self.client.chat.completions.create(
            model="solar-pro2",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_message}
            ],
            temperature=0.1,
            max_tokens=300,
            reasoning_effort="low"
        )
        
        elapsed = time.time() - start_time
        result = response.choices[0].message.content.strip()
        print(f"solar-pro2 응답 완료: {elapsed:.2f}초 | 길이: {len(result)}자")
        return result
    
    def _get_startup_news(self) -> str:
        """창업진흥원 관련 뉴스 가져오기 (임시 비활성화)"""
        today = datetime.now().strftime("%Y년 %m월 %d일")
        return f"📮 오늘의 창업진흥원 뉴스 ({today})\n\n뉴스 기능이 일시적으로 비활성화되었습니다.\n시스템 안정화 후 다시 제공될 예정입니다."
    
    async def search(self, user_query: str, user_id: Optional[str] = None) -> dict:
        """전체 에이전트 시스템 실행"""
        total_start = time.time()
        # 이모지가 포함된 명령어는 출력 대신 간단히 표시
        if "🌟 새로운 대화시작" in user_query:
            print("\n[대화 초기화 명령 처리 중...]")
        else:
            print(f"\n전체 요청 시작: '{user_query}'")
        
        # 📮 오늘의 창업진흥원 명령어 처리
        if user_query.strip() == "📮 오늘의 창업진흥원":
            news_result = self._get_startup_news()
            return {
                "query": user_query,
                "answer": news_result,
                "total_time": "0.1초"
            }
        
        # 🌟 새로운 대화시작 명령어 처리
        if user_query.strip() == "🌟 새로운 대화시작":
            if user_id:
                self.memory.clear_user_history(user_id)
                print(f"사용자 {user_id}의 대화 이력을 초기화했습니다.")
                
                return {
                    "query": user_query,
                    "answer": "새로운 대화를 시작합니다! 이전 대화 내용은 모두 초기화되었어요. 창업진흥원 규정에 대해 궁금한 점을 물어보세요.",
                    "total_time": "0.01초"
                }
            else:
                return {
                    "query": user_query, 
                    "answer": "새로운 대화를 시작합니다! 창업진흥원 규정에 대해 궁금한 점을 물어보세요.",
                    "total_time": "0.01초"
                }
        
        # 사용자 질문을 메모리에 저장
        if user_id:
            self.memory.add_message(user_id, "user", user_query)
        
        # 1단계: 분류 에이전트 (빠른 응답) - 대화 맥락 포함
        selected_file = self._classification_agent(user_query, user_id)
        
        # 2단계: 답변 생성 에이전트 (빠른 응답)
        answer = self._response_agent(user_query, selected_file, user_id)
        
        # 응답을 메모리에 저장 (선택된 규정 정보 포함)
        if user_id:
            self.memory.add_message(user_id, "assistant", answer, selected_file)
        
        total_elapsed = time.time() - total_start
        print(f"전체 요청 완료: {total_elapsed:.2f}초\n" + "="*50 + "\n")
        
        return {
            "query": user_query,
            "answer": answer,
            "total_time": f"{total_elapsed:.2f}초"
        }
